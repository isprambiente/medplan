import {Calendar} from '@fullcalendar/core';
import interactionPlugin from '@fullcalendar/interaction';
import dayGridPlugin from '@fullcalendar/daygrid';
import allLocales from '@fullcalendar/core/locales-all';
import DualListbox from 'dual-listbox/dist/dual-listbox';
import Rails from "@rails/ujs";
import PageController from './page_controller';

export default class extends PageController {

  connect() {
    var listbox, select;

    if (this.hasCalendarTarget) {
      this.calendar = this.Calendar();
      this.calendar.render();
    }
    if (this.hasListboxTarget) {
      select = this.listboxTarget;
      return listbox = new DualListbox(select, {
        availableTitle: 'Categorie disponibili',
        selectedTitle: 'Categorie selezionate',
        addButtonText: '>',
        removeButtonText: '<',
        addAllButtonText: '>>',
        removeAllButtonText: '<<'
      });
    }
  }

  openDetails(event) {
    var icon, infoTarget;

    icon = event.target;
    infoTarget = icon.closest('.parent-info').querySelector('span.info');
    if (infoTarget) {
      if (icon.classList.contains('fa-plus-circle')) {
        infoTarget.classList.remove('is-hidden');
      } else {
        infoTarget.classList.add('is-hidden');
      }
    }
    icon.classList.toggle('fa-plus-circle');
    return icon.classList.toggle('fa-minus-circle');
  }

  renderEvent(event) {
    var container, data, status, target, xhr;

    [data, status, xhr] = event.detail;
    target = event.currentTarget;
    container = target.closest('.event');
    return container.outerHTML = xhr.response;
  }

  refreshMeeting(event) {
    var container, target;

    if (this.hasContainerTarget) {
      target = event.currentTarget;
      container = this.containerTarget;
      return Rails.ajax({
        type: "GET",
        url: `/<%= I18n.t( 'events', scope: 'routes', default: 'events' ) %>/${target.dataset.eventId}/<%= I18n.t( 'edit', scope: 'routes', default: 'edit' ) %>`,
        success: (response, status, xhr) => {
          return container.innerHTML = xhr.response;
        },
        error: (error) => {
          return this.send("Si è verificato un errore durante il caricamento! Si prega di provare più tardi.", "error");
        }
      });
    }
  }

  refreshCalendar(event) {
    var calendar;

    if (this.hasCalendarTarget) {
      calendar = this.calendarTarget;
    } else {
      calendar = document.getElementById('calendar');
    }
    calendar.innerHTML = '';
    calendar = this.Calendar(calendar);
    return calendar.render();
  }

  Calendar(target = this.calendarTarget) {
    var cal, url;

    url = target.dataset.eventsUrl;
    cal = new Calendar(target, {
      plugins: [interactionPlugin, dayGridPlugin],
      selectable: target.classList.contains('editable'),
      editable: target.classList.contains('editable'),
      aspectRatio: 1.5,
      locales: allLocales,
      locale: document.getElementsByTagName('html')[0].lang,
      events: `${url}/agenda.json`,
      eventClick: (info) => {
        info.jsEvent.preventDefault();
        if (info.event.url) {
          url = info.event.url;
          return Rails.ajax({
            type: "GET",
            url: `${url}/<%= I18n.t( 'edit', scope: 'routes', default: 'edit' ) %>`,
            success: (response, status, xhr) => {
              var modal;
              modal = document.getElementById('modal');
              if (modal) {
                modal.querySelector('.modal-card-title').innerHTML = `${info.event.extendedProps.gender === 'visit' ? 'Visite' : 'Analisi'} a ${info.event.extendedProps.city} del ${info.event.extendedProps.date_on}`;
                modal.querySelector('.modal-card-body').innerHTML = xhr.response;
                modal.classList.add('is-active');
                return modal.closest('html').classList.add('is-clipped');
              }
            },
            error: (error) => {
              return this.send("Si è verificato un errore durante il caricamento! Si prega di provare più tardi.", "error");
            }
          });
        }
      }
    });
    return cal;
  }

}